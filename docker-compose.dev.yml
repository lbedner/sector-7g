# Development overrides
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml --profile dev up
#
# Adds:
#   - Code volume mounts for hot-reload
#   - Debug ports for direct service access

services:
  webserver:
    volumes:
      - .:/code
    labels:
      # Dev router (HTTP, localhost â€” no TLS)
      - "traefik.http.routers.webserver-dev.rule=Host(`localhost`) || Host(`127.0.0.1`)"
      - "traefik.http.routers.webserver-dev.entrypoints=web"
      - "traefik.http.routers.webserver-dev.service=webserver"
      # Admin paths in dev
      - "traefik.http.routers.webserver-admin.rule=PathPrefix(`/dashboard`) || PathPrefix(`/docs`) || PathPrefix(`/redoc`) || PathPrefix(`/openapi.json`)"
      - "traefik.http.routers.webserver-admin.entrypoints=web"
      - "traefik.http.routers.webserver-admin.service=webserver"
      - "traefik.http.routers.webserver-admin.middlewares=admin-ipallowlist"
      - "traefik.http.middlewares.admin-ipallowlist.ipallowlist.sourcerange=${ADMIN_IP_ALLOWLIST:-0.0.0.0/0}"

  scheduler:
    volumes:
      - .:/code

  worker-inanimate-rod:
    volumes:
      - .:/code

  worker-homer:
    volumes:
      - .:/code

  worker-lenny:
    volumes:
      - .:/code

  worker-carl:
    volumes:
      - .:/code

  worker-charlie:
    volumes:
      - .:/code

  worker-grimey:
    volumes:
      - .:/code

  redis:
    ports:
      - "6379:6379"

  postgres:
    ports:
      - "5432:5432"

  traefik:
    volumes:
      - ./traefik/traefik.dev.yml:/etc/traefik/traefik.yml:ro
    ports:
      - "80:80"
      - "8080:8080"  # Dashboard

  test_runner:
    volumes:
      - .:/code